<!DOCTYPE html>
<html>
<head>
  <title>ACIAR projects</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0,  user-scalable=no">
  <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
  <link rel="stylesheet" href="lib/select2/select2.css" />

  <style>
    html, body, #map {
      height:100%;
      width:100%;
      padding:0px;
      margin:0px;
      font-family: "Myriad Pro","Droid Sans",Arial,sans-serif;
    }

    .popupLabel {
      color:grey;
    }

    .select2-container .select2-choice {
      height:32px;
    }

    #select2-chosen-1 {
      line-height:32px;
    }
  </style>

</head>
<body>
  <div id="map"></div>

  <div id="countrySelect" style="position:absolute; top:15px; right:15px; width: 200px;">
  </div>

  <script src="lib/jquery-1.11.1.min.js"></script>
  <script src="lib/select2/select2.min.js"></script>
  <script src="lib/mustache.js"></script>
  <script src="lib/leaflet/leaflet-src.js"></script>

  <script id="template" type="x-tmpl-mustache">
    <p style="display:inline;font-weight:bold;"> {{ project }} </p><br>
    <hr>
    <span class="popupLabel">UN ID</span> {{ un_id }} <br>
    <span class="popupLabel">Location</span> {{ approximate_location_nearest_town }} <br>
    <span class="popupLabel">Country</span> {{ country }} <br>
    <span class="popupLabel">Project leader</span> {{ project_leader }} <br>
    <span class="popupLabel">Project manager</span> {{ aciar_project_manager }} <br>
    <span class="popupLabel">Web page</span> <a href="{{ project_url }}" target="blank"> link </a> <br>
    <hr>
    <a class="zoomTo" href="#{{ un_id }}">Zoom in</a><a class="zoomTo" style="float:right;" href="#">Zoom out</a>
  </script>

  <script>

    function formatCountry(state) {
      if (!state.id) return state.text; // optgroup
      return "<img class='flag' src='images/flags/" + state.text.toLowerCase() + ".png'/><p style='vertical-align:top;display:inline;line-height:32px;margin-left:8px;'>" + state.text + "</p>";
    };

    // Not setting the viewport yet (fitting it to the data)
    var map = L.map('map',{
      zoomAnimationThreshold: 6
    });

    // Setting a nice looking OSM basemap served from MapBox
    L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      id: 'examples.map-i86knfo3'
    }).addTo(map);

    var template = $('#template').html();
    Mustache.parse(template);   // optional, speeds up future uses

    // Attaching a popup with a rendered Mustache template to a feature
    function attachPopup(feature, layer) {
      // does this feature have a property named popupContent?
      if (feature.properties) {
        var rendered = Mustache.render(template, feature.properties);
        layer.bindPopup(rendered);
      }
    };

    function zoomToProject(id) {
      if (id)
      {
        // Find the project in the projectLayer by its UN ID
        var projectFeature;
        for (l in projectLayer._layers)
        {
          if (projectLayer._layers[l].feature.properties.un_id == id)
          {
            //console.log("Found it!");
            // Getting the feature properties in a variable
            projectFeature = projectLayer._layers[l];
            break;
          }
        }

        // Zoom to this project (center, and increase zoom level)
        map.setView(new L.latLng(projectFeature.feature.properties.dd_y, projectFeature.feature.properties.dd_x),8,{animate:true});

        // Opening up the popup on this feature
        projectFeature.openPopup();
      }
      else
      {
        // Setting the viewport to the data bounds
        map.fitBounds(projectLayer.getBounds());
      }
    }

    // Get project ID from URL
    var projectIdInUrl;
    if(window.location.hash) {
      // Fragment exists
      projectIdInUrl = window.location.hash.substr(1);
    }

    var geojsonMarkerOptions = {
      radius: 12,
      color: "#000",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9
    };

    // 12 colors brewed
    var colorBrewer = [ '#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9', '#bc80bd', '#ccebc5', '#ffed6f'];

    // The vector layer to overlay comes from CartoDB via the "sql" endpoint
    var projectLayer = new L.GeoJSON(null,{
      onEachFeature: attachPopup,
      pointToLayer: function (feature,latlng) {
                      geojsonMarkerOptions.fillColor = colorBrewer[feature.properties.no];
                      return L.circleMarker(latlng, geojsonMarkerOptions);
                    }
    });

    // Adding the layer to the map
    map.addLayer(projectLayer);

    $.getJSON(
        "http://aciar.cartodb.com/api/v2/sql?q=SELECT%20*%20FROM%20aciar_projects%20WHERE%20dd_y%20%3C%3E%20%27%27%20AND%20dd_x%20%3C%3E%20%27%27&format=geojson&callback=?",
        function(geojson) {
          var countryArr = [], countrySelect = [], countryId = 0;

          // Adding the GeoJSON data to the Leaflet GeoJSON layer
          $.each(geojson.features, function(i, feature) {
            projectLayer.addData(feature);

            // Build an array of countries without duplicates
            if($.inArray(feature.properties.country, countryArr) === -1)
            {
              countryArr.push(feature.properties.country);
            }
          });

          // Sorting alphabetically for better presentation
          countryArr.sort();

          // Building the slect box data array of id/text
          for (c in countryArr)
          {
            countrySelect.push({id:(countryId++).toString(),text:countryArr[c]});
          }

          // The country array to initialise the country select box
          $('#countrySelect').select2({
            data: countrySelect,
            placeholder: "Filter by country",
            allowClear: true,
            formatResult: formatCountry,
            formatSelection: formatCountry,
            escapeMarkup: function(m) { return m; }
          })
            .on("change", function(e) { 
              //console.log("change "+JSON.stringify({val:e.val, added:e.added, removed:e.removed}));
              var visibleFeatureArr = [];
              if (e.added)
              {
                // A selection has been operated, we need to filter the projects by the selected country
                $.each(map._layers,function(i,f) {
                  if (f.feature && f.feature.properties)
                  {
                    if (f.feature.properties.country == e.added.text) {
                      f.setStyle({opacity:0.9,fillOpacity:0.9});
                      visibleFeatureArr.push(new L.latLng(f.feature.properties.dd_y,f.feature.properties.dd_x));
                    } else {f.setStyle({opacity:0.3,fillOpacity:0.3});}
                  }
                });
              }
              else
              {
                // A deselection has been operated, we need to remove the country filter
                $.each(map._layers,function(i,f) {
                  if (f.feature) {
                    f.setStyle({opacity:0.9,fillOpacity:0.9});
                    visibleFeatureArr.push(new L.latLng(f.feature.properties.dd_y,f.feature.properties.dd_x));
                  }
                });
              }

              // Setting the viewport to these visible features only, with a 10% buffer
              map.fitBounds(new L.latLngBounds(visibleFeatureArr).pad(0.1));

              // Closing a popup if it was opened
              $.each(map._layers,function(i,f) {
                if (f.closePopup) {
                  f.closePopup();
                }
              });
            }).on("select2-close", function () {
              setTimeout(function() {
                  $('.select2-container-active').removeClass('select2-container-active');
                  $(':focus').blur();
              }, 1);
            });

          // Zoom to project in URL or to bounding box of all projects
          zoomToProject(projectIdInUrl);
        }
    );

    map.on('popupopen', function() {  
      $('a.zoomTo').click(function(){
        // Clicked project
        var clickedProject = $(this).attr("href").substr(1);
        //console.log(clickedProject);
        zoomToProject(clickedProject);
      });
    });

  </script>
</body>
</html>
